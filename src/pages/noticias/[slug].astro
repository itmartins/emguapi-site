---
// src/pages/noticias/[slug].astro
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import Navbar from '../../components/Navbar.astro';
import NoticiaCard from '../../components/NoticiaCard.astro'; 

export async function getStaticPaths() {
  const noticiaEntries = await getCollection('noticias');
  return noticiaEntries.map(entry => ({
    params: { slug: entry.id.replace(/\.md$/, '') }, 
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();

// --- LÓGICA DE NOTÍCIAS RELACIONADAS ---
const allNoticias = await getCollection('noticias');
const noticiasRelacionadas = allNoticias
    .filter(n => n.id !== entry.id)
    .sort((a, b) => new Date(b.data.data).getTime() - new Date(a.data.data).getTime())
    .slice(0, 3);

const nomeAutor = entry.data.autor || "Equipe emguapi";
const autorSlug = nomeAutor.toLowerCase().trim().replace(/\s+/g, '-');

const dataFormatada = new Date(entry.data.data).toLocaleDateString('pt-BR', {
  day: '2-digit',
  month: 'long',
  year: 'numeric'
});

// URLs para compartilhamento
const shareUrl = `https://emguapi.vercel.app/noticias/${entry.id.replace(/\.md$/, '')}`;
const shareText = encodeURIComponent(entry.data.titulo);
---

<Layout 
    title={`${entry.data.titulo} | emguapi.com`}
    description={entry.data.resumo}
    image={entry.data.imagem}
    tags={entry.data.tags}
>
    <Navbar />
    
    <main class="max-w-4xl mx-auto my-12 bg-white dark:bg-[#112240] shadow-2xl rounded-[3rem] overflow-hidden border border-ice dark:border-white/5">
        
        <header class="relative h-[400px]">
            <img 
                src={entry.data.imagem || "/fotos/estacao-guapi.jpg"} 
                class="w-full h-full object-cover" 
                alt={entry.data.titulo} 
            />
            <div class="absolute inset-0 bg-gradient-to-t from-navy-dark via-transparent"></div>
            <div class="absolute bottom-10 left-10 right-10">
                <span class="bg-red-base text-white text-[10px] font-black px-4 py-1.5 rounded-full uppercase mb-4 inline-block tracking-widest shadow-xl">
                    {entry.data.categoria}
                </span>
                <h1 class="text-3xl md:text-5xl font-black text-white uppercase italic tracking-tighter leading-none mb-4 drop-shadow-lg">
                    {entry.data.titulo}
                </h1>
            </div>
        </header>

        <article class="p-8 md:p-16">
            
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-10 pb-8 border-b border-ice dark:border-white/10">
                <div class="text-navy-safe dark:text-gray-400 text-sm font-bold uppercase tracking-widest">
                    {dataFormatada} | Por 
                    <a href={`/autor/${autorSlug}`} class="text-red-base hover:underline">
                        {nomeAutor}
                    </a>
                </div>

                <div class="flex flex-wrap gap-2">
                    <a href={`https://wa.me/?text=${shareText}%20${shareUrl}`} target="_blank" aria-label="WhatsApp" class="bg-[#25D366] hover:bg-[#20bd5a] text-white p-2.5 md:px-4 md:py-2 rounded-lg md:rounded-full transition-all shadow-sm hover:-translate-y-1 flex items-center gap-2 group">
                        <svg class="w-4 h-4 fill-current" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.463 1.065 2.875 1.213 3.074.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>
                        <span class="hidden md:inline text-xs font-black uppercase">WhatsApp</span>
                    </a>

                    <a href={`https://www.facebook.com/sharer/sharer.php?u=${shareUrl}`} target="_blank" aria-label="Facebook" class="bg-[#1877F2] hover:bg-[#166fe5] text-white p-2.5 md:px-4 md:py-2 rounded-lg md:rounded-full transition-all shadow-sm hover:-translate-y-1 flex items-center gap-2">
                        <svg class="w-4 h-4 fill-current" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                        <span class="hidden md:inline text-xs font-black uppercase">Facebook</span>
                    </a>

                    <a href={`https://twitter.com/intent/tweet?text=${shareText}&url=${shareUrl}`} target="_blank" aria-label="X / Twitter" class="bg-black hover:bg-gray-800 dark:bg-white dark:text-black dark:hover:bg-gray-200 text-white p-2.5 md:px-4 md:py-2 rounded-lg md:rounded-full transition-all shadow-sm hover:-translate-y-1 flex items-center gap-2">
                        <svg class="w-4 h-4 fill-current" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                        <span class="hidden md:inline text-xs font-black uppercase">X</span>
                    </a>
                    
                    <a href={`https://t.me/share/url?url=${shareUrl}&text=${shareText}`} target="_blank" aria-label="Telegram" class="bg-[#24A1DE] hover:bg-[#2090c7] text-white p-2.5 md:px-4 md:py-2 rounded-lg md:rounded-full transition-all shadow-sm hover:-translate-y-1 flex items-center gap-2">
                        <svg class="w-4 h-4 fill-current" viewBox="0 0 24 24"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 11.944 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>
                        <span class="hidden md:inline text-xs font-black uppercase">Telegram</span>
                    </a>

                    <a href={`https://www.linkedin.com/sharing/share-offsite/?url=${shareUrl}`} target="_blank" aria-label="LinkedIn" class="bg-[#0077b5] hover:bg-[#006396] text-white p-2.5 md:px-4 md:py-2 rounded-lg md:rounded-full transition-all shadow-sm hover:-translate-y-1 flex items-center gap-2">
                        <svg class="w-4 h-4 fill-current" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
                         <span class="hidden md:inline text-xs font-black uppercase">LinkedIn</span>
                    </a>
                </div>
            </div>

            <div class="mb-12 py-8 border-y border-dashed border-ice dark:border-white/10 flex flex-col items-center">
                <span class="text-[9px] font-black text-navy-soft uppercase tracking-[0.3em] mb-4">Publicidade</span>
                <div class="w-full h-48 md:h-32 bg-[#000066] dark:bg-[#0a192f] rounded-2xl flex items-center justify-center group cursor-pointer hover:border-red-base border-2 border-transparent transition-all overflow-hidden relative">
                    <img src="/banners/seu-anuncio.webp" 
                        class="w-full h-full object-contain transition-opacity duration-300 opacity-90 group-hover:opacity-100" 
                        alt="Anúncio Giga Mais">
                    <a href="https://www.gigamaisfibra.com.br/" target="_blank" class="absolute inset-0 z-10">
                        <span class="sr-only">Visitar site do anunciante</span>
                    </a>
                </div>
            </div>

            <div class="
                prose prose-lg max-w-none text-navy-dark dark:text-gray-200 leading-relaxed
                prose-headings:font-black prose-headings:text-navy-dark dark:prose-headings:text-white
                prose-a:text-red-base hover:prose-a:text-red-light
                prose-strong:text-navy-dark dark:prose-strong:text-white prose-strong:font-black
                prose-img:rounded-2xl prose-img:shadow-lg prose-img:w-full
                
                /* Estilos para Vídeos */
                [&_iframe]:w-full [&_iframe]:aspect-video [&_iframe]:rounded-2xl [&_iframe]:shadow-lg [&_iframe]:mb-8
                
                /* Estilos para Legendas */
                [&_figure]:my-8 [&_figure]:block
                [&_figcaption]:text-center [&_figcaption]:text-sm [&_figcaption]:text-navy-soft dark:[&_figcaption]:text-gray-400 [&_figcaption]:italic [&_figcaption]:mt-2 [&_figcaption]:font-medium

                /* Letra Capitular */
                [&>p:first-of-type::first-letter]:float-left
                [&>p:first-of-type::first-letter]:text-[3.5rem]
                [&>p:first-of-type::first-letter]:leading-[0.8]
                [&>p:first-of-type::first-letter]:font-black
                [&>p:first-of-type::first-letter]:mr-3
                [&>p:first-of-type::first-letter]:mt-1
                [&>p:first-of-type::first-letter]:text-red-base
                [&>p:first-of-type::first-letter]:uppercase

                /* Citações */
                prose-blockquote:not-italic prose-blockquote:font-bold prose-blockquote:text-navy-base dark:prose-blockquote:text-gray-200
                prose-blockquote:bg-ice dark:prose-blockquote:bg-white/5
                prose-blockquote:border-l-8 prose-blockquote:border-red-base
                prose-blockquote:py-4 prose-blockquote:px-6 prose-blockquote:rounded-r-xl prose-blockquote:shadow-sm
            ">
                <Content />
            </div>

            {entry.data.tags && entry.data.tags.length > 0 && (
                <div class="mt-10 mb-10 pt-8 border-t border-dashed border-ice dark:border-white/10">
                    <h4 class="text-xs font-black uppercase tracking-widest text-navy-soft mb-3">Tópicos Relacionados:</h4>
                    <div class="flex flex-wrap gap-2">
                        {entry.data.tags.map(tag => (
                            <span class="bg-gray-100 dark:bg-white/10 hover:bg-red-base hover:text-white dark:text-gray-300 dark:hover:text-white text-navy-base px-3 py-1.5 rounded-lg text-xs font-bold uppercase tracking-wide transition-colors cursor-default shadow-sm border border-gray-200 dark:border-white/5">
                                #{tag}
                            </span>
                        ))}
                    </div>
                </div>
            )}
            
            <div class="mt-20 pt-12 border-t-2 border-ice dark:border-white/10">
                <h3 class="text-xl font-black uppercase tracking-tighter text-navy-dark dark:text-white mb-8 flex items-center gap-3 italic">
                    <span class="w-10 h-1.5 bg-red-base inline-block"></span>
                    Você pode gostar
                </h3>
                
                <div class="grid md:grid-cols-3 gap-6">
                    {noticiasRelacionadas.map(noticia => (
                        <div class="transform md:scale-95 md:origin-top-left hover:scale-100 transition-transform duration-300"> 
                            <NoticiaCard 
                                categoria={noticia.data.categoria}
                                titulo={noticia.data.titulo}
                                resumo=""
                                data={noticia.data.data}
                                link={`/noticias/${noticia.id.replace(/\.md$/, '')}`}
                                imagem={noticia.data.imagem || "/fotos/estacao-guapi.jpg"}
                            />
                        </div>
                    ))}
                </div>
            </div>

            <footer class="mt-12 pt-8 border-t border-ice dark:border-white/10 flex justify-between items-center">
                <a href="/noticias" class="text-navy-base dark:text-gray-300 font-black uppercase text-xs hover:text-red-base transition-colors">
                    ← Voltar para todas as Notícias
                </a>
            </footer>

            <div class="mb-12 py-8 border-y border-dashed border-ice dark:border-white/10 flex flex-col items-center">
                <span class="text-[9px] font-black text-navy-soft uppercase tracking-[0.3em] mb-4">Publicidade</span>
                <div class="w-full h-48 md:h-32 bg-[#000066] dark:bg-[#0a192f] rounded-2xl flex items-center justify-center group cursor-pointer hover:border-red-base border-2 border-transparent transition-all overflow-hidden relative">
                    <img src="/banners/seu-anuncio.webp" 
                        class="w-full h-full object-contain transition-opacity duration-300 opacity-90 group-hover:opacity-100" 
                        alt="Anúncio Giga Mais">
                    <a href="https://www.gigamaisfibra.com.br/" target="_blank" class="absolute inset-0 z-10">
                        <span class="sr-only">Visitar site do anunciante</span>
                    </a>
                </div>
            </div>
        </article>
    </main>
</Layout>